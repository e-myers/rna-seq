
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

## Expression heatmaps

#### Each comparison (PV Early, PV Late, TTX Early, TTX Late) has two heatmaps: one for the top-ranked genes that decrease in the TTX condition, and one for those that increase.  Genes are ordered by p-value (increasing).  P-values are based on limma-voom.
#### Expression values are log2(TPM).
#### Color scales are not equal across plots.
#### Formatted similarly to Fig. 3 in Okaty et al 2009, https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2749660/#R70.

```{r, echo=FALSE}

library(plotly)

# Define some variables
projectPath =  '/Users/nelsonlab/Documents/Results_temporarily_here/TTX_results/'
N = 100      # number of genes in each heatmap
ncolors = 5  # number of colors to have in palette
ylabSize = 8 # font size for gene symbols
figHeight = 2000
figWidth = 300

getFileNames = function(path, cellType, stage) {
  comparison = paste(cellType, stage, sep = '_')
  fileTPM = paste(projectPath, comparison, '_TPM.csv', sep = '')
  fileLimma = paste(projectPath, comparison, '_limma_ranked_genes.csv', sep = '')
  filenames = list(fileTPM=fileTPM, fileLimma=fileLimma)
}

getExprMat = function(filename) {
  # Input: Csv file containing expression matrix
  # Output: Expression matrix, with gene symbols as row names
  exprMat = read.csv(filename)
  rownames(exprMat) = exprMat[,1]  # Move the gene symbols into row names
  exprMat = exprMat[,-1] # Get rid of first column, that has gene symbols
  return(exprMat)
  }

getTopIdx = function(exprMat, filename, n) {
  # Inputs:  Expression matrix, file with pvals from limma, number of genes
  # Outputs: Data frame with indexes (in expr matrix) of the 100 top-ranked genes down-regulated with TTX; same for up-regulated, and the effect size (log fold change) for each.  All ordered by effect size.
  df = read.csv(filename)
  dfDn = df[which(df$Direction == 'dnTTX'),]
  dfUp = df[which(df$Direction == 'upTTX'),]
  dfDnTop = dfDn[1:n,]
  dfUpTop = dfUp[1:n,]
  lfcRanksDn = order(abs(dfDnTop$LFC), decreasing=TRUE)
  lfcRanksUp = order(abs(dfUpTop$LFC), decreasing=TRUE)
  dfDnTopSorted = dfDnTop[lfcRanksDn,]
  dfUpTopSorted = dfUpTop[lfcRanksUp,]
  topIdx = data.frame(dnIdx = match(dfDnTopSorted$Gene.symbol, rownames(exprMat)),
                      upIdx = match(dfUpTopSorted$Gene.symbol, rownames(exprMat)),
                      dnLFC = dfDnTopSorted$LFC, upLFC = dfUpTopSorted$LFC)
  return(topIdx)
}

# For use in prepExprMat.  Or actually maybe right before plotting instead.
normFun = function(v) {vnorm = (v-min(v)) / (max(v)-min(v)); return(vnorm)}

prepExprMat = function(exprMat, idx) {
  # Inputs: Expression matrix, row indexes
  # Outputs:  Matrix of log2 expression, with 0 values where expression was 0, vertically flipped for heatmap
  exprMatL2 = log2(exprMat[idx,])
  exprMatL2[exprMat[idx,] == 0] = 0
  exprMatL2Rev = apply(exprMatL2, 2, rev)
  return(exprMatL2Rev)
}

makeHeatmap = function(exprForPlot, xlabs, figHeight, figWidth, ylabSize, cellType, stage, direction) {
  # Figure out if minimum value is negative, since that affects how we want to set the lower limit of the color scale
  minFactor = 0.95; if (min(exprForPlot) < 0) {minFactor = 1.05}
  minVal = min(exprForPlot)*minFactor
  # Define plotly object
  p = plot_ly(z = exprForPlot, x = xlabs, y = rownames(exprForPlot), type='heatmap', colors = colorRamp(c('yellow', 'red')), zmin = minVal, zmax = max(exprForPlot*minFactor), height=figHeight, width = figWidth)
  # p = layout(p, yaxis = list(tickfont = list(size = ylabSize), ticklen = 0), 
  #      xaxis = list(ticklen = 0), 
  #      title = paste(cellType, stage, ',', direction))
  # # lenmode and len aren't actually affecting the color bar height
  # colorbar(p, limits = c(minVal, max(exprForPlot*minFactor)), lenmode = 'fraction',  len = 0.25, thickness = 30)
  return(p)
}

```


```{r, echo=FALSE}

# This is the only code that should change for each comparison
cellType = 'EMX'
stage = 'Late'


# Get TPMs and indexes in TPM matrix of top-ranking genes (up and down, separately)
filenames = getFileNames(projectPath, cellType, stage)
tpms = getExprMat(filenames$fileTPM)
topIdx = getTopIdx(tpms, filenames$fileLimma, N)

# Get values to display for up- and down-regulated genes
# Normalize within-gene to 0-to-1 range
exprForPlotDn_unscaled = prepExprMat(tpms, topIdx$dnIdx)
exprForPlotUp_unscaled = prepExprMat(tpms, topIdx$upIdx)
exprForPlotDn = t(apply(exprForPlotDn_unscaled, 1, normFun))
exprForPlotUp = t(apply(exprForPlotUp_unscaled, 1, normFun))

# Get x-labels
xlabs = colnames(tpms)
xlabs = sub(cellType, '', sub(paste(stage, '_', sep=''), '', colnames(tpms)))

# My makeHeatmap() function won't do the layout and colorbar stuff so there's some more hackery going on here

# Heatmap for down-regulated genes
pDn = makeHeatmap(exprForPlotDn, xlabs, figHeight, figWidth, ylabSize, cellType, stage, 'down-regulated with TTX')
minFactor = 0.95; if (min(exprForPlotDn) < 0) {minFactor = 1.05}
minVal = min(exprForPlotDn)*minFactor
layout(pDn, yaxis = list(tickfont = list(size = ylabSize), ticklen = 0), 
       xaxis = list(ticklen = 0), 
       title = paste(cellType, stage, ',', 'down-regulated with TTX'))
# lenmode and len aren't actually affecting the color bar height
# colorbar(pDn, limits = c(minVal, max(exprForPlotDn*minFactor)), lenmode = 'fraction',  len = 0.25, thickness = 30)

# LFC - Heatmap is reversing colorscale, while colorbar is correct??
c = character(2); c[1] = '.'; c[2] = '.'
pLfcDn = plot_ly(z = cbind(rev(abs(topIdx$dnLFC)), rev(abs(topIdx$dnLFC))), type = 'heatmap', 
        x = rep('.', times=2), y = rownames(exprForPlotDn),
        colors = colorRamp(c('blue', 'green')), 
        height = figHeight, width = 200)
layout(pLfcDn, 
       yaxis = list(tickfont = list(size = ylabSize), ticklen = 0), 
       xaxis = list(ticklen = 0), 
       title = 'LFC, down with TTX')


# Mean log2(TPM)
c = character(2); c[1] = '.'; c[2] = '.'
meanColRamp = c('turquoise1', 'magenta')
# meanColRamp = c('skyblue', 'magenta')
# meanColRamp = c('turquoise', 'violet')
pMeanDn = plot_ly(z = cbind(rowMeans(exprForPlotDn_unscaled), rowMeans(exprForPlotDn_unscaled)), type = 'heatmap', 
        x = rep('.', times=2), y = rownames(exprForPlotDn),
        colors = colorRamp(rev(meanColRamp)), 
        height = figHeight, width = 200)
layout(pMeanDn, 
       yaxis = list(tickfont = list(size = ylabSize), ticklen = 0), 
       xaxis = list(ticklen = 0), 
       title = 'Mean log(TPM), down with TTX')


############################################################
# Heatmap for up-regulated genes
############################################################

pUp = makeHeatmap(exprForPlotUp, xlabs, figHeight, figWidth, ylabSize, cellType, stage, 'up-regulated with TTX')
minFactor = 0.95; if (min(exprForPlotUp) < 0) {minFactor = 1.05}
minVal = min(exprForPlotUp)*minFactor
layout(pUp, yaxis = list(tickfont = list(size = ylabSize), ticklen = 0), 
       xaxis = list(ticklen = 0), 
       title = paste(cellType, stage, ',', 'up-regulated with TTX'))
# lenmode and len aren't actually affecting the color bar height
# colorbar(pUp, limits = c(minVal, max(exprForPlotUp*minFactor)), lenmode = 'fraction',  len = 0.25, thickness = 30)

# LFC - Heatmap is reversing colorscale, while colorbar is correct??
# Doing it once to get the correct heatmap and once to get the correct colorbar b/c I don't have time for this shit, plotly.
c = character(2); c[1] = '.'; c[2] = '.'
pLfcUp = plot_ly(z = cbind(rev(abs(topIdx$upLFC)), rev(abs(topIdx$upLFC))), type = 'heatmap', 
        x = rep('.', times=2), y = rownames(exprForPlotUp),
        colors = colorRamp(c('blue', 'green')), 
        height = figHeight, width = 200)
layout(pLfcUp, 
       yaxis = list(tickfont = list(size = ylabSize), ticklen = 0), 
       xaxis = list(ticklen = 0), 
       title = 'LFC, up with TTX')

# Mean log2(TPM)
c = character(2); c[1] = '.'; c[2] = '.'
# meanColFun = colorRampPalette(c('turquoise1', 'magenta'))
# meanCols = meanColFun(N)
meanColRamp = c('turquoise1', 'magenta')
# meanColRamp = c('skyblue', 'magenta')
# meanColRamp = c('turquoise', 'violet')
pMeanUp = plot_ly(z = cbind(rowMeans(exprForPlotUp_unscaled), rowMeans(exprForPlotUp_unscaled)), type = 'heatmap', 
        x = rep('.', times=2), y = rownames(exprForPlotUp),
        colors = colorRamp(rev(meanColRamp)), 
        height = figHeight, width = 200)
layout(pMeanUp, 
       yaxis = list(tickfont = list(size = ylabSize), ticklen = 0), 
       xaxis = list(ticklen = 0), 
       title = 'Mean log(TPM), up with TTX')





# # Doesn't include the stuff that was in layout and colorbar commands; doing that stuff in Illustrator

export(p=pDn, file=paste('/Users/nelsonlab/Documents/', cellType, '_', stage, '_dn.pdf', sep = ''))
export(p=pLfcDn, file=paste('/Users/nelsonlab/Documents/', cellType, '_', stage, '_dn_lfc.pdf', sep = ''))
export(p=pMeanDn, file=paste('/Users/nelsonlab/Documents/', cellType, '_', stage, '_dn_mean.pdf', sep = ''))

export(p=pUp, file=paste('/Users/nelsonlab/Documents/', cellType, '_', stage, '_up.pdf', sep = ''))
export(p=pLfcUp, file=paste('/Users/nelsonlab/Documents/', cellType, '_', stage, '_up_lfc.pdf', sep = ''))
export(p=pMeanUp, file=paste('/Users/nelsonlab/Documents/', cellType, '_', stage, '_up_mean.pdf', sep = ''))

```

